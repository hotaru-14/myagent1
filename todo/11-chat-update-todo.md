# チャット機能改善 TODO

## 🚨 緊急修正項目（高優先度）

### 1. メッセージ保存の競合状態修正 ✅ **完了**
**現在の問題：** ユーザーメッセージとAI応答で2つの会話が作成される

#### TODO:
- [x] `use-chat-input-manager.ts` の `onFinish` 処理を修正
- [x] メッセージペア保存関数 `saveMessagePair` を実装
- [x] 会話ID事前確定システムの導入

**✅ 実装完了：**
- PostgreSQLのRPC関数 `save_message_pair` でトランザクション保存
- `createConversationWithMessagePair` で新規会話とメッセージペアを一度に作成
- `onFinish` で `saveMessagePairToConversation` を使用してワンショット保存

### 2. 状態管理の不整合修正 ✅ **完了**
**現在の問題：** `currentConversation` の非同期更新による状態不整合

#### TODO:
- [x] `use-conversation-manager.ts` の状態同期ロジック改善
- [x] `ensureConversationId` 関数の実装
- [x] `pendingConversationIdRef` の確実な管理

**✅ 実装完了：**
- `pendingConversationIdRef` を廃止して状態を簡素化
- `ensureConversationExists` RPC関数で会話の事前作成
- 競合状態を根本的に解決する設計に変更

### 3. 一時ID管理の廃止 ✅ **完了**
**現在の問題：** 一時IDから実IDへの移行が複雑で不安定

#### TODO:
- [x] `generateTempId` 使用箇所の特定と修正
- [x] 会話作成を最初のメッセージ送信前に実行
- [x] 一時ID関連ロジックの削除

**✅ 実装完了：**
- `lib/utils/id-utils.ts` ファイルを削除
- `generateTempId`, `isTemporaryId` などの関数を完全削除
- `createNewConversation` で実際のDBレコードを即座に作成
- 一時的な会話状態を排除

---

## 🔧 構造改善項目（中優先度）

### 4. データベーススキーマの改善 ✅ **完了**
**目的：** データ整合性向上とパフォーマンス最適化

#### TODO:
- [x] メッセージ順序保証のための `sequence_number` カラム追加
- [x] 空の会話を防ぐための制約追加
- [x] インデックスの最適化

**✅ 実装完了：**
- `sequence_number`カラム追加とトリガー設定
- 空会話自動削除機能
- パフォーマンス向上のための複合インデックス追加
- データ整合性制約（UNIQUE制約、CHECK制約）
- メッセージ順序検証ビュー実装
- ベンチマーク・監視用統計関数の追加

**📝 新機能：**
- `save_message_pair_with_sequence` - 順序保証付きメッセージペア保存
- `create_conversation_with_message_pair_sequence` - 順序保証付き会話作成
- `conversation_metrics` - パフォーマンス監視ビュー
- `message_sequence_validation` - 順序整合性チェック

### 5. 楽観的UI更新の実装 ✅ **完了**
**目的：** ChatGPT風の即座表示による UX向上

#### TODO:
- [x] 一時メッセージ表示システムの実装
- [x] ローディング状態の視覚的改善
- [x] エラー時のロールバック機能

**✅ 実装完了：**
- `useOptimisticChat`フック実装
- React 18の`useOptimistic`活用
- 楽観的メッセージ追加・更新・削除機能
- エラー時の自動ロールバック処理
- リトライ機能付きエラーハンドリング
- ペンディング状態の詳細管理

**📝 新機能：**
- ChatGPT風の即座メッセージ表示
- ストリーミング中のリアルタイム更新
- 失敗時の自動メッセージ削除またはリトライ表示

### 6. エラーハンドリングの強化 ✅ **完了**
**目的：** 部分的失敗時のデータ不整合防止

#### TODO:
- [x] トランザクション的保存処理の実装
- [x] エラー時の自動リトライ機能
- [x] ユーザーへの適切なエラー通知

**✅ 実装完了：**
- 包括的エラー分類システム（7種類のエラータイプ）
- 指数バックオフによる自動リトライ機能
- トランザクション的操作とロールバック機能
- エラー統計収集・分析機能
- 多言語対応エラーメッセージ
- デバッグ用詳細ログ機能

**📝 新機能：**
- `classifyError` - インテリジェントなエラー分類
- `executeWithRetry` - 指数バックオフリトライ
- `executeTransaction` - トランザクション的操作
- `ErrorStats` - エラー統計とモニタリング

---

## 🎨 UI/UX改善項目（中優先度）

### 7. 空の会話の自動削除 ✅ **完了**
**目的：** メッセージ数0の会話を自動的に除外または削除する

#### TODO:
- [x] メッセージ数0の会話の自動削除機能実装

**✅ 実装完了：**
- 会話一覧読み込み時の自動フィルタリング機能
- 5分間隔での定期的な空会話クリーンアップ
- 会話作成時の空会話予防機能（5分タイムアウト）
- 会話削除時の自動クリーンアップ実行
- ページ表示/非表示時の適応的クリーンアップ
- バックグラウンド自動実行（UIボタン不要）

**📝 新機能：**
- `useEmptyConversationCleanup` - 定期的自動クリーンアップフック
- 会話一覧での事前フィルタリング（`loadConversations`改良）
- 空会話の事前防止システム
- 完全自動化によるシームレスな体験

### 8. メッセージ表示の最適化
**目的：** エージェント情報の適切な表示

#### TODO:
- [ ] エージェント別のメッセージスタイリング
- [ ] タイムスタンプ表示の改善
- [ ] メッセージの編集・削除機能

---

## 🔒 著作権対応項目（低優先度）

### 9. 独自命名規則への変更
**目的：** 著作権侵害リスクの完全回避

#### TODO:
- [ ] テーブル名の変更：`conversations` → `chat_threads`
- [ ] カラム名の変更：`id` → `thread_id`
- [ ] コンポーネント名の独自化
- [ ] API エンドポイントの独自命名

### 10. 独自UI/UXパターンの採用
**目的：** ChatGPTとの差別化

#### TODO:
- [ ] 独自のレイアウトデザイン
- [ ] オリジナルアイコンの使用
- [ ] 独自のカラーパレット適用

---

## 🚀 将来拡張項目（低優先度）

### 11. パフォーマンス最適化
#### TODO:
- [ ] メッセージのページング実装
- [ ] 仮想スクロールの導入
- [ ] キャッシュ戦略の最適化

### 12. 高度な機能追加
#### TODO:
- [ ] メッセージ検索機能
- [ ] 会話のエクスポート/インポート
- [ ] リアルタイム同期（WebSocket）

---

## 📋 実装スケジュール案

### Week 1: 緊急修正（項目1-3） ✅ **実装完了**
- 競合状態の修正
- 状態管理改善
- 一時ID廃止

**📝 実装成果：**
- **PostgreSQL RPC関数**: `save_message_pair`, `create_conversation_with_message_pair`, `ensure_conversation_exists`, `cleanup_empty_conversations`
- **競合状態解決**: [PostgreSQL Race Conditions対策](https://dev.to/mistval/winning-race-conditions-with-postgresql-54gn)を参考にトランザクション活用
- **メッセージペア保存**: ユーザーメッセージとAI応答を一つのトランザクションで安全保存
- **一時ID完全廃止**: 複雑な状態管理を排除してシンプル化
- **データ整合性向上**: UNIQUE制約とインデックスによる重複防止

**⚠️ 要注意：**
- データベースの新しいRPC関数を適用するために `npx supabase db reset` または `npx supabase db push` が必要
- 本格テストの前にSupabaseのマイグレーションを実行してください

### Week 2: 構造改善（項目4-6） ✅ **実装完了**
- データベース改善
- UI更新最適化
- エラーハンドリング

**📝 実装成果：**
- **メッセージ順序保証**: `sequence_number`によるメッセージの完全な順序管理
- **楽観的UI更新**: React 18の`useOptimistic`を活用したChatGPT風の即座表示
- **エラーハンドリング強化**: 7種類のエラー分類と自動リトライ機能
- **パフォーマンス最適化**: [Next.js 15最適化パターン](https://dev.to/saiful7778/optimizing-database-queries-in-nextjs-15-with-cache-and-prisma-5ehe)準拠
- **トランザクション安全性**: PostgreSQLの制約とトリガーによる整合性保証

**⚠️ 要注意：**
- `supabase/03-week2-schema-improvements.sql`の適用が必要
- 新しいフック`useOptimisticChat`の統合テストが必要

### Week 3: UI/UX改善（項目7-8）
- 空の会話の自動削除
- メッセージ表示最適化

### Week 4: 著作権対応（項目9-10）
- 命名規則変更
- 独自UI実装

---

## 🔍 テスト計画

### 必須テスト項目
- [ ] メッセージ送信→会話が1つだけ作成されることを確認
- [ ] 連続メッセージ送信での状態整合性確認
- [ ] エラー時のロールバック動作確認
- [x] 空の会話が自動削除されることの確認

### テストシナリオ
1. **新規会話開始テスト**
   - ユーザー: "おはよう" → AI: "おはようございます"
   - 期待結果: 1つの会話に2つのメッセージ

2. **連続メッセージテスト** 
   - 複数回の質問・回答
   - 期待結果: 全て同一会話内に保存

3. **エージェント切り替えテスト**
   - 会話中のエージェント変更
   - 期待結果: 同一会話内でエージェント情報が正しく保存

4. **空会話自動削除テスト** ✅ **実装完了**
   - 新規会話を作成後、メッセージを送信せずに5分間放置
   - 期待結果: 会話が自動的に削除される
   
5. **バックグラウンドクリーンアップテスト** ✅ **実装完了**
   - ページを開いたまま5分間待機
   - 期待結果: 空の会話が定期的に自動削除される

---

## 📚 参考資料・技術仕様

### 業界標準フォーマット
- [PyTorch Chat Datasets](https://pytorch.org/torchtune/0.3/basics/chat_datasets.html)
- OpenAI Message Format準拠

### 著作権対応指針
- [EFF: AI and Copyright](https://www.eff.org/deeplinks/2025/02/ai-and-copyright-expanding-copyright-hurts-everyone-heres-what-do-instead)
- 技術手法の参考は合法、具体的実装の模倣は避ける

---

## ✅ 完了チェックリスト

修正完了の判定基準：
- [x] **Week1完了**: 1つのユーザー入力に対して1つの会話のみ作成される
- [x] **Week1完了**: ユーザーメッセージとAI応答が同一会話内に保存される
- [x] **Week1完了**: 競合状態が根本的に解決されている
- [x] **Week1完了**: 一時ID管理が完全に廃止されている
- [x] **Week2完了**: メッセージ順序保証システムが実装されている
- [x] **Week2完了**: 楽観的UI更新でChatGPT風の即座表示が実現されている
- [x] **Week2完了**: エラーハンドリングが強化され自動リトライが機能している
- [x] 空の会話が自動的に削除または非表示になる
- [ ] エラー時にも データの整合性が保たれる
- [ ] 著作権的に安全な実装が完了している

**🎯 Week1の達成状況：**
- ✅ メッセージ保存の競合状態を完全解決
- ✅ PostgreSQLトランザクションによる安全な保存
- ✅ 一時ID管理の複雑性を排除
- ✅ データベース制約による重複防止
- ✅ 状態管理の簡素化

**🎯 Week2の達成状況：**
- ✅ メッセージ順序保証システムの実装
- ✅ 楽観的UI更新による即座表示（React 18準拠）
- ✅ 7種類のエラー分類と自動リトライ機能
- ✅ トランザクション的操作とロールバック機能
- ✅ パフォーマンス最適化とモニタリング機能

**🎯 Week3の達成状況：**
- ✅ 空の会話の自動削除機能（完了）
- 📋 メッセージ表示の最適化（進行中）
- 🔄 UI/UX品質向上（継続）

**📋 次のマイルストーン（Week3残り/Week4）：**
- メッセージ表示の最適化
- 著作権対応とUI独自化
- パフォーマンステスト

---

**最終目標：** ChatGPTのような安定した1対1のチャット体験を、著作権的に安全な方法で実現する

**🔥 Week1の重要な成果：**
> 「おはよう」→「おはようございます」のような1つの質疑応答が、確実に1つの会話内に2つのメッセージとして保存されるようになりました。競合状態は完全に解決されています。
