name: 10-todo-test - Dashboard Migration Tests

# PRæ™‚ã¨mainãƒ–ãƒ©ãƒ³ãƒã¸ã®pushæ™‚ã«ãƒˆãƒªã‚¬ãƒ¼
on:
  pull_request:
    branches: [main, master]
  push:
    branches: [main, master]

# ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
env:
  NODE_VERSION: '18'
  COVERAGE_THRESHOLD: 70

jobs:
  # ðŸ”§ åŸºæœ¬ãƒã‚§ãƒƒã‚¯ï¼ˆLintã€TypeScriptã€ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆï¼‰
  lint-and-type-check:
    name: ðŸ”§ Lint and Type Check
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ðŸ“¥ Install dependencies
        run: npm ci
      
      - name: ðŸ” TypeScript type check
        run: npx tsc --noEmit
      
      - name: ðŸ§¹ ESLint check
        run: npm run lint
      
      - name: ðŸŽ¨ Prettier format check
        run: npm run format:check
        continue-on-error: true  # ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã‚¨ãƒ©ãƒ¼ã§ã‚‚ã‚¸ãƒ§ãƒ–ã‚’ç¶™ç¶š

  # ðŸ§ª ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
  unit-tests:
    name: ðŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: lint-and-type-check
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ðŸ“¥ Install dependencies
        run: npm ci
      
      - name: ðŸ§ª Run unit tests with coverage
        run: npm run test:coverage
      
      - name: ðŸ“Š Check coverage threshold
        run: |
          COVERAGE=$(npx jest --coverage --passWithNoTests --silent | grep "Lines" | awk '{print $2}' | sed 's/%//' || echo "0")
          echo "Coverage: $COVERAGE%"
          if [ "$COVERAGE" -lt "$COVERAGE_THRESHOLD" ]; then
            echo "âŒ Coverage $COVERAGE% is below threshold $COVERAGE_THRESHOLD%"
            echo "::warning::Code coverage ($COVERAGE%) is below the required threshold ($COVERAGE_THRESHOLD%)"
          else
            echo "âœ… Coverage $COVERAGE% meets threshold $COVERAGE_THRESHOLD%"
          fi
      
      - name: ðŸ“¤ Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports
          path: coverage/

  # ðŸ—ï¸ ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
  build-test:
    name: ðŸ—ï¸ Build Test
    runs-on: ubuntu-latest
    needs: lint-and-type-check
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ðŸ“¥ Install dependencies
        run: npm ci
      
      - name: ðŸ”¨ Build application
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_SUPABASE_URL: "https://dummy.supabase.co"
          NEXT_PUBLIC_SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.dummy"
      
      - name: ðŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-files
          path: .next/

  # ðŸŒ E2Eãƒ†ã‚¹ãƒˆ (ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–)
  e2e-tests:
    name: ðŸŒ E2E Tests (Disabled)
    runs-on: ubuntu-latest
    needs: [unit-tests, build-test]
    timeout-minutes: 10
    if: false  # ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ðŸ“¥ Install dependencies
        run: npm ci
      
      - name: ðŸŽ­ Install Playwright browsers
        run: npx playwright install --with-deps chromium
      
      - name: ðŸš€ Run E2E tests
        run: npm run test:e2e
        env:
          CI: true
      
      - name: ðŸ“¤ Upload E2E test results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: e2e-test-results
          path: |
            test-results/
            playwright-report/

  # ðŸ›¡ï¸ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å›ºæœ‰ãƒ†ã‚¹ãƒˆï¼ˆprotected â†’ dashboardç§»è¡Œï¼‰
  dashboard-migration-tests:
    name: ðŸ›¡ï¸ Dashboard Migration Tests
    runs-on: ubuntu-latest
    needs: build-test
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ðŸ“¥ Install dependencies
        run: npm ci
      
      - name: ðŸ”¨ Build application
        run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: "https://dummy.supabase.co"
          NEXT_PUBLIC_SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.dummy"
      
      - name: ðŸš€ Start application
        run: |
          npm start &
          npx wait-on http://localhost:3000 --timeout 60000
        env:
          NODE_ENV: production
          NEXT_PUBLIC_SUPABASE_URL: "https://dummy.supabase.co"
          NEXT_PUBLIC_SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.dummy"
      
      - name: âŒ Test old protected route returns 404
        run: |
          echo "Testing /protected route returns 404..."
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/protected || echo "000")
          echo "Response code: $response"
          if [ "$response" != "404" ]; then
            echo "âŒ /protected should return 404, got $response"
            exit 1
          else
            echo "âœ… /protected correctly returns 404"
          fi
      
      - name: âœ… Test new dashboard route accessibility
        run: |
          echo "Testing /dashboard route accessibility..."
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/dashboard || echo "000")
          echo "Response code: $response"
          if [ "$response" != "200" ] && [ "$response" != "302" ] && [ "$response" != "307" ]; then
            echo "âŒ /dashboard should be accessible (200) or redirect (302/307), got $response"
            exit 1
          else
            echo "âœ… /dashboard is accessible (response: $response)"
          fi
      
      - name: ðŸ” Verify routing changes
        run: |
          echo "Verifying no remaining /protected references in code..."
          # JavaScriptãƒ•ã‚¡ã‚¤ãƒ«å†…ã®/protectedã®å‚ç…§ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åã¯é™¤å¤–ï¼‰
          if grep -r "/protected" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --exclude-dir=node_modules --exclude-dir=.next --exclude-dir=.git . | grep -v "todo" | grep -v "test"; then
            echo "âŒ Found remaining /protected references in code"
            exit 1
          else
            echo "âœ… No remaining /protected references found in code"
          fi

  # ðŸ“Š ãƒ†ã‚¹ãƒˆçµæžœã¾ã¨ã‚
  test-summary:
    name: ðŸ“Š Test Summary
    runs-on: ubuntu-latest
    needs: [lint-and-type-check, unit-tests, build-test, dashboard-migration-tests]
    if: always()
    steps:
      - name: ðŸ“‹ Check test results
        run: |
          echo "## ðŸŽ¯ Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Test Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”§ Lint & Type Check | ${{ needs.lint-and-type-check.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Unit Tests | ${{ needs.unit-tests.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—ï¸ Build Test | ${{ needs.build-test.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ E2E Tests | â¸ï¸ Disabled |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ›¡ï¸ Dashboard Migration | ${{ needs.dashboard-migration-tests.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.lint-and-type-check.result }}" == "success" && "${{ needs.unit-tests.result }}" == "success" && "${{ needs.build-test.result }}" == "success" && "${{ needs.dashboard-migration-tests.result }}" == "success" ]]; then
            echo "ðŸŽ‰ **Core tests passed!** Ready to merge. (E2E tests temporarily disabled)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Some tests failed.** Please review and fix before merging." >> $GITHUB_STEP_SUMMARY
          fi 