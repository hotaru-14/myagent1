name: ğŸš€ PR Tests - Empty Conversation Cleanup

# PRæ™‚ã®è»½é‡ãƒ†ã‚¹ãƒˆï¼ˆå¿…è¦æœ€ä½é™ï¼‰
on:
  pull_request:
    branches: [main, master]
    types: [opened, synchronize, reopened]

# å¿…è¦æœ€ä½é™ã®ç’°å¢ƒå¤‰æ•°
env:
  NODE_VERSION: '18'
  COVERAGE_THRESHOLD: 50  # ä½ã‚ã«è¨­å®š

jobs:
  # ğŸ¯ é‡è¦æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆï¼ˆç©ºã®ä¼šè©±å‰Šé™¤æ©Ÿèƒ½ï¼‰
  critical-feature-tests:
    name: ğŸ¯ Critical Feature Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¥ Install dependencies
        run: npm ci --prefer-offline --no-audit
      
      - name: ğŸ§ª Run empty conversation cleanup tests
        run: |
          echo "ğŸ§ª Testing empty conversation cleanup functionality..."
          npx jest tests/10-todo-test/unit/hooks/use-empty-conversation-cleanup.test.ts --verbose
          npx jest tests/10-todo-test/unit/database/empty-conversation-cleanup.test.ts --verbose

  # ğŸ”§ åŸºæœ¬ãƒã‚§ãƒƒã‚¯ï¼ˆè»½é‡ç‰ˆï¼‰
  basic-checks:
    name: ğŸ”§ Basic Checks
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¥ Install dependencies
        run: npm ci --prefer-offline --no-audit
      
      - name: ğŸ” TypeScript check (specific files)
        run: |
          echo "ğŸ” Checking TypeScript for critical files..."
          npx tsc --noEmit lib/hooks/use-empty-conversation-cleanup.ts
          npx tsc --noEmit lib/hooks/use-chat-storage.ts
      
      - name: ğŸ§¹ Lint check (specific files)
        run: |
          echo "ğŸ§¹ Linting critical files..."
          npx eslint lib/hooks/use-empty-conversation-cleanup.ts lib/hooks/use-chat-storage.ts --max-warnings 0 || true

  # ğŸ—ï¸ ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆï¼ˆè»½é‡ç‰ˆï¼‰
  build-test:
    name: ğŸ—ï¸ Build Test
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: basic-checks
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¥ Install dependencies
        run: npm ci --prefer-offline --no-audit
      
      - name: ğŸ”¨ Build application
        run: |
          echo "ğŸ”¨ Building application..."
          npm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_SUPABASE_URL: "https://dummy.supabase.co"
          NEXT_PUBLIC_SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.dummy"

  # ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒã‚§ãƒƒã‚¯ï¼ˆé‡è¦æ©Ÿèƒ½ã®ã¿ï¼‰
  coverage-check:
    name: ğŸ“Š Coverage Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: critical-feature-tests
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¥ Install dependencies
        run: npm ci --prefer-offline --no-audit
      
      - name: ğŸ“Š Run coverage for critical files
        run: |
          echo "ğŸ“Š Checking coverage for critical functionality..."
          npx jest --coverage --collectCoverageFrom="lib/hooks/use-empty-conversation-cleanup.ts" tests/10-todo-test/unit/hooks/use-empty-conversation-cleanup.test.ts tests/10-todo-test/unit/database/empty-conversation-cleanup.test.ts --coverageThreshold='{"global":{"lines":'"$COVERAGE_THRESHOLD"',"functions":'"$COVERAGE_THRESHOLD"',"branches":'"$COVERAGE_THRESHOLD"',"statements":'"$COVERAGE_THRESHOLD"'}}'

  # âœ… PR ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é›†ç´„
  pr-status:
    name: âœ… PR Status
    runs-on: ubuntu-latest
    needs: [critical-feature-tests, basic-checks, build-test, coverage-check]
    if: always()
    steps:
      - name: ğŸ“‹ Check overall status
        run: |
          echo "=== PR ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼ ==="
          echo "ğŸ¯ é‡è¦æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ: ${{ needs.critical-feature-tests.result }}"
          echo "ğŸ”§ åŸºæœ¬ãƒã‚§ãƒƒã‚¯: ${{ needs.basic-checks.result }}"
          echo "ğŸ—ï¸ ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ: ${{ needs.build-test.result }}"
          echo "ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒã‚§ãƒƒã‚¯: ${{ needs.coverage-check.result }}"
          
          if [[ "${{ needs.critical-feature-tests.result }}" == "success" && "${{ needs.basic-checks.result }}" == "success" && "${{ needs.build-test.result }}" == "success" && "${{ needs.coverage-check.result }}" == "success" ]]; then
            echo "âœ… ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼PRã‚’ãƒãƒ¼ã‚¸ã§ãã¾ã™ã€‚"
          else
            echo "âŒ ä¸€éƒ¨ã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            exit 1
          fi 